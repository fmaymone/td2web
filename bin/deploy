#!/bin/bash

DEPLOY_ENV=$1
DATE_STR=$(date +%y%m%d%H%M)
PAAS_COMMAND_STAGING=tdv2dokku
STAGING_REMOTE=staging
STAGING_APP=staging.tdv2.bellingham.dev
# PROD_REMOTE=production
# PRODUCTION_APP=www.tdv2.bellingham.dev
# PAAS_COMMAND_PROD=tdv2dokku

case $DEPLOY_ENV in
staging)
  echo "*** Deploying to Staging"
  last_tag=$(git rev-list -n 1 staging-current)
  tag="staging-$DATE_STR"
  echo "  - Creating tag $tag"
  git tag -f $tag
  git push --tags -f
  echo "  - Pushing code to Staging"
  git push $STAGING_REMOTE $tag:master
  echo "  - Running Migrations"
  $PAAS_COMMAND_STAGING run $STAGING_APP rake db:migrate
  git tag -f staging-current
  git push origin --tags -f
  echo " - Deploy Complete"
  echo " - Changelog"
  git log $last_tag.. --oneline
  ;;
prod)
  #####
  echo "!!! Production deployments not supported"
  exit
  ####

  echo "** Deploying to Production"
  last_tag=$(git rev-list -n 1 prod-current)
  tag="prod-$date_str"
  echo "  - Creating tag $tag"
  git tag -f $tag
  git push origin --tags -f
  echo "  - Pushing code to Production"
  git push $PROD_REMOTE $tag:master
  echo "  - Running Migrations"
  $PAAS_COMMAND_PROD run rake db:migrate --app $PRODUCTION_APP
  git tag -f prod-current
  git push origin --tags -f
  echo " - Deploy Complete"
  echo " - Changelog"
  git log $last_tag.. --oneline
  ;;
*)
  echo "*** Environment unknown or not provided. Cowardly exiting."
  echo "Usage: bin/deploy (staging|prod)"
  exit
  ;;
esac

